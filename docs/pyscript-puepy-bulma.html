<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<!-- this_file: docs/pyscript-puepy-bulma.html -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boabro Font Inspector - Analyze Font Files Online</title>
<meta name="description" content="Analyze and preview font files online. Upload TTF, OTF, WOFF files or use a URL to explore font metadata, tables, and features.">
<meta name="keywords" content="font inspector, font analyzer, font preview, font metadata, OpenType, TrueType, WOFF, font tools">
<meta name="author" content="Adam Twardoch">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¤</text></svg>">

<!-- Open Graph / Social Sharing -->
<meta property="og:title" content="Boabro Font Inspector - Analyze Font Files Online">
<meta property="og:description" content="Upload a font file or use a URL to analyze and preview fonts. Examine metadata, tables, and OpenType features instantly.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://github.com/twardoch/boabro">
<meta property="og:image" content="https://repository-images.githubusercontent.com/123456789/abcdef-1234-5678-9abc-1234567890ab">
<!-- Bulma CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- PyScript CSS and JS -->
<link rel="stylesheet" href="https://pyscript.net/releases/2024.10.2/core.css">
<script type="module" src="https://pyscript.net/releases/2024.10.2/core.js"></script>
<style>
  /* CSS Custom Properties for consistent colors */
  :root {
    --bg-primary: #121212;
    --bg-surface: #1e1e2d;
    --bg-elevated: #2d2d3a;
    --border-subtle: rgba(255, 255, 255, 0.1);
    --border-visible: rgba(255, 255, 255, 0.2);
    --text-primary: rgba(255, 255, 255, 0.95);
    --text-secondary: rgba(255, 255, 255, 0.8);
    --text-tertiary: rgba(255, 255, 255, 0.6);
    --accent-primary: #7c4dff;
    --accent-hover: #9969ff;
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
  }

  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
  }

  .navbar.is-dark {
    background: var(--bg-elevated);
    box-shadow: var(--shadow-md);
    border-bottom: 1px solid var(--border-subtle);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .box {
    background-color: var(--bg-surface);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-visible);
    transition: all 0.3s ease;
  }

  .box:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }

  .title, .subtitle {
    color: var(--text-primary);
  }

  .button.is-primary {
    background-color: var(--accent-primary);
    transition: all 0.3s ease;
    border: none;
  }

  .button.is-primary:hover {
    background-color: var(--accent-hover);
    transform: translateY(-1px);
  }

  .button.is-light {
    background-color: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid var(--border-visible);
  }

  .button.is-light:hover {
    background-color: var(--bg-surface);
    color: var(--text-primary);
    border-color: var(--border-visible);
  }

  .input, .select select {
    background-color: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid var(--border-visible);
    box-shadow: inset var(--shadow-sm);
  }

  .input:focus, .select select:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 2px rgba(124, 77, 255, 0.25);
  }

  .notification.is-light {
    background-color: var(--bg-elevated);
    color: var(--text-primary);
  }

  .notification.is-danger {
    background-color: #cf6679;
    color: #000000;
  }

  .debug-console {
    max-height: 200px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-visible);
    border-radius: 8px;
    padding: 1rem;
    color: var(--text-primary);
  }

  .debug-console div {
    padding: 4px 0;
    border-bottom: 1px solid var(--border-subtle);
  }

  .file-cta {
    background-color: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid var(--border-visible);
  }

  .file:hover .file-cta {
    background-color: var(--bg-surface);
    color: var(--text-primary);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg-surface);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--bg-elevated);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--accent-primary);
  }

  /* Loading animation */
  @keyframes pulse {
    0% { opacity: 0.4; }
    50% { opacity: 0.8; }
    100% { opacity: 0.4; }
  }

  .loading-pulse {
    animation: pulse 1.5s infinite ease-in-out;
  }

  /* Font info display */
  .font-info {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }

  .font-info-item {
    background: var(--bg-elevated);
    border: 1px solid var(--border-visible);
    border-radius: 8px;
    padding: 1rem;
  }

  .font-info-label {
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .font-info-value {
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg-primary);
    padding: 0.75rem;
    border-radius: 4px;
    border: 1px solid var(--border-subtle);
    word-break: break-all;
  }

  pre {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid var(--border-subtle);
  }
  
  /* Font preview section */
  .font-preview {
    background-color: var(--bg-elevated);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    border: 1px solid var(--border-visible);
  }
  
  .preview-text {
    font-size: 2rem;
    line-height: 1.4;
    margin-bottom: 1rem;
    word-break: break-word;
  }
  
  .preview-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .preview-size-control {
    width: 100%;
    max-width: 300px;
  }
  
  /* Tabs for font information */
  .tabs-content .tab-content {
    display: none;
    padding: 1rem;
    background-color: var(--bg-surface);
    border-radius: 0 0 8px 8px;
    border: 1px solid var(--border-visible);
    border-top: none;
  }
  
  .tabs-content .tab-content.is-active {
    display: block;
  }
  
  .tabs li.is-active a {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }
  
  /* Help modal */
  .modal-card-head, .modal-card-foot {
    background-color: var(--bg-elevated);
    border-color: var(--border-visible);
  }
  
  .modal-card-body {
    background-color: var(--bg-surface);
    color: var(--text-primary);
  }
  
  .modal-card-title {
    color: var(--text-primary);
  }
  
  /* Responsive improvements */
  @media screen and (max-width: 768px) {
    .preview-controls {
      flex-direction: column;
    }
    
    .preview-size-control {
      max-width: 100%;
    }
  }
</style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar is-dark" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">
        <i class="fas fa-font mr-2"></i>
        <strong>Boabro Font Inspector</strong>
      </a>
      
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
    
    <div id="navMenu" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons">
            <a class="button is-light is-small js-modal-trigger" data-target="helpModal">
              <span class="icon">
                <i class="fas fa-question-circle"></i>
              </span>
              <span>Help</span>
            </a>
            <a class="button is-primary is-small" href="https://github.com/twardoch/boabro" target="_blank" rel="noopener">
              <span class="icon">
                <i class="fab fa-github"></i>
              </span>
              <span>GitHub</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Help Modal -->
<div id="helpModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Font Inspector Help</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="content">
        <h4>About This Tool</h4>
        <p>The Boabro Font Inspector allows you to analyze font files in various formats: TrueType (.ttf), OpenType (.otf), Web Open Font Format (.woff, .woff2).</p>
        
        <h4>How to Use</h4>
        <ol>
          <li><strong>Upload a font file:</strong> Drag and drop a font file into the upload area, or click to select a file</li>
          <li><strong>Or provide a URL:</strong> Enter a direct link to a font file</li>
          <li><strong>Process the font:</strong> Click "Process Font" to analyze the font</li>
          <li><strong>View results:</strong> Once processed, you can preview the font and see its details</li>
        </ol>
        
        <h4>Features</h4>
        <ul>
          <li><strong>Font Preview:</strong> Test the font with custom text and size adjustments</li>
          <li><strong>Basic Info:</strong> View essential font metadata (family name, style, version, etc.)</li>
          <li><strong>Tables:</strong> Examine OpenType/TrueType tables present in the font</li>
          <li><strong>Features:</strong> See the list of OpenType features (if available)</li>
        </ul>
        
        <h4>Troubleshooting</h4>
        <p>Common issues and solutions:</p>
        <ul>
          <li><strong>CORS errors:</strong> If loading from a URL fails, try downloading the font file and uploading it directly</li>
          <li><strong>File format:</strong> Make sure you're using a supported font format (.ttf, .otf, .woff, .woff2)</li>
          <li><strong>Large files:</strong> Very large font files may take longer to process</li>
          <li><strong>Preview issues:</strong> If the preview doesn't show properly, try a different font or browser</li>
        </ul>
        
        <h4>About Boabro</h4>
        <p>Boabro is a collection of open-source font tools. Visit the <a href="https://github.com/twardoch/boabro" target="_blank" rel="noopener">GitHub repository</a> for more information and other tools.</p>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-primary">Got it!</button>
    </footer>
  </div>
</div>

<section class="section">
  <div class="container main-container">
    <div class="columns is-centered">
      <div class="column is-10">
        <div class="box">
          <h2 class="title is-4 has-text-centered mb-5">
            <span class="icon mr-2">
              <i class="fas fa-font"></i>
            </span>
            Boabro Font Inspector Tool
          </h2>
          <div id="app">
            <div class="has-text-centered py-5">
              <div class="button is-loading is-primary is-large loading-pulse"></div>
              <p class="mt-3">Loading application...</p>
            </div>
          </div>
        </div>
        
        <div class="box mt-4">
          <h3 class="title is-5 has-text-centered mb-4">
            <span class="icon mr-2">
              <i class="fas fa-terminal"></i>
            </span>
            Debug Console
          </h3>
          <div id="debug" class="debug-console p-3"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<footer class="footer has-background-dark has-text-centered py-3">
  <div class="content has-text-grey-light">
    <p>
      Boabro Font Inspector Tool &copy; 2025 | 
      <a href="https://github.com/twardoch/boabro" target="_blank" rel="noopener" class="has-text-grey-light">GitHub</a> | 
      Built with <a href="https://pyscript.net/" target="_blank" rel="noopener" class="has-text-grey-light">PyScript</a>, 
      <a href="https://github.com/twardoch/puepy" target="_blank" rel="noopener" class="has-text-grey-light">Puepy</a>, and 
      <a href="https://bulma.io/" target="_blank" rel="noopener" class="has-text-grey-light">Bulma</a>
    </p>
  </div>
</footer>

<script type="py" config='{"packages":["puepy","fonttools"], "paths": ["../../src"]}'>
from puepy import Page, Application, t
import io
import traceback
import json
# from fontTools.ttLib import TTFont # No longer directly used here
from js import document, console, window, Blob, Object # Added Blob and Object for type conversion
from pyodide.ffi import create_proxy, to_js # Added to_js for Uint8Array conversion

from boabro.boabro import analyze_font_data, fetch_font_bytes_from_url

def debug_log(message):
    debug_div = document.getElementById("debug")
    if debug_div:
        debug_div.innerHTML += f"<div>{message}</div>"
        # Auto-scroll to bottom
        debug_div.scrollTop = debug_div.scrollHeight
    console.log(message)

debug_log("Script started")

app = Application()

@app.page()
class FontInspector(Page):
    def initial(self):
        debug_log("Initial state created")
        return {
            "info": "",
            "error": "",
            "file_data": None,
            "font_url": "https://github.com/google/fonts/raw/refs/heads/main/ofl/abrilfatface/AbrilFatface-Regular.ttf",
            "is_processing": False,
            "font_loaded": False,
            "preview_text": "The quick brown fox jumps over the lazy dog",
            "preview_size": 36,
            "font_name": "",
            "active_tab": "basic",
            "detailed_info": {},
        }

    def populate(self):
        t.h3("Upload Font File", class_="title is-5 mb-4")
        
        # Font input section
        with t.div(class_="box"):
            t.p("Select a .ttf or .otf font file to analyze, or provide a URL:", class_="mb-3")
            
            # File upload field
            with t.div(class_="field"):
                t.label("Font File", for_="font-upload", class_="label")
                with t.div(class_="control has-icons-left"):
                    t.input(
                        type="file",
                        accept=".ttf,.otf",
                        id="font-upload",
                        class_="input",
                        on_change="fileSelected(event)",
                    )
                    with t.span(class_="icon is-small is-left"):
                        t.i(class_="fas fa-file")
            
            # Show selected filename
            with t.div(class_="field mt-2"):
                with t.div(class_="control"):
                    t.div(
                        "Selected file: ",
                        t.span("No file chosen", id="file-name-display"),
                        class_="is-size-7 has-text-grey"
                    )
            
            # Font URL field
            with t.div(class_="field mt-3"):
                t.label("Font URL", for_="font-url", class_="label")
                with t.div(class_="control has-icons-left"):
                    t.input(
                        type="url",
                        id="font-url",
                        class_="input",
                        value=self.state["font_url"],
                        placeholder="https://example.com/font.ttf",
                        on_input=self.on_url_change,
                    )
                    with t.span(class_="icon is-small is-left"):
                        t.i(class_="fas fa-link")
                t.p("If both file and URL are provided, the file will be used.", class_="help")
            
            # Process button
            with t.div(class_="field mt-4"):
                with t.div(class_="control"):
                    button_text = "Processing..." if self.state["is_processing"] else "Process Font"
                    button_class = "button is-primary is-loading" if self.state["is_processing"] else "button is-primary"
                    t.button(
                        button_text,
                        class_=button_class,
                        on_click=self.on_process_click,
                        disabled=self.state["is_processing"],
                    )
            
            # Preset fonts list for quick testing
            with t.div(class_="field mt-4"):
                t.label("Or try a preset font:", class_="label")
                with t.div(class_="control"):
                    with t.div(class_="select is-fullwidth"):
                        with t.select(id="preset-font", on_change="presetFontChanged(event)"):
                            t.option("Select a preset font...", value="", selected="selected")
                            t.option("Abril Fatface (Serif Display)", value="https://github.com/google/fonts/raw/main/ofl/abrilfatface/AbrilFatface-Regular.ttf")
                            t.option("Roboto (Sans-Serif)", value="https://github.com/google/fonts/raw/main/apache/roboto/Roboto-Regular.ttf")
                            t.option("Open Sans (Sans-Serif)", value="https://github.com/google/fonts/raw/main/ofl/opensans/OpenSans-Regular.ttf")
                            t.option("Source Code Pro (Monospace)", value="https://github.com/google/fonts/raw/main/ofl/sourcecodepro/SourceCodePro-Regular.ttf")
                            t.option("Lora (Serif)", value="https://github.com/google/fonts/raw/main/ofl/lora/Lora-Regular.ttf")
                            t.option("Montserrat (Sans-Serif)", value="https://github.com/google/fonts/raw/main/ofl/montserrat/Montserrat-Regular.ttf")
            
            # Add script to handle preset font selection
            t.script("""
            function presetFontChanged(event) {
                const fontUrl = event.target.value;
                if (fontUrl) {
                    document.getElementById('font-url').value = fontUrl;
                    // Trigger processing
                    const processButton = document.getElementById('process-button');
                    if (processButton) {
                        processButton.click();
                    }
                }
            }
            """)
                        
            # Loading animation overlay (hidden by default)
            with t.div(id="loading-overlay", class_="modal", style="display: none;"):
                with t.div(class_="modal-background", style="background-color: rgba(0, 0, 0, 0.7);"):
                    t.text("")
                with t.div(class_="modal-content has-text-centered">
                    with t.div(class_="box" style="background-color: var(--bg-elevated); max-width: 400px; margin: 0 auto;"):
                        with t.div(class_="mb-4">
                            t.progress(class_="progress is-primary", max="100")
                        t.p("Processing font file...", id="loading-message", class_="has-text-white")
                        with t.p(class_="is-size-7 mt-2 has-text-grey">
                            t.text("This may take a moment depending on the font size and complexity")
                            
            # Error modal for better error visibility
            with t.div(id="error-modal", class_="modal"):
                with t.div(class_="modal-background"):
                    t.text("")
                with t.div(class_="modal-card"):
                    with t.header(class_="modal-card-head has-background-danger-dark"):
                        t.p("Error", class_="modal-card-title has-text-white")
                        with t.button(class_="delete", aria_label="close", on_click="closeErrorModal()"):
                            t.text("")
                    with t.section(class_="modal-card-body"):
                        t.p(id="error-message", class_="has-text-danger")
                    with t.footer(class_="modal-card-foot"):
                        with t.div(class_="buttons is-centered w-100"):
                            t.button("OK", class_="button is-danger", on_click="closeErrorModal()")
            
            # Add script to show/hide loading overlay and error modal
            t.script("""
            function showLoading(message) {
                const loadingOverlay = document.getElementById('loading-overlay');
                const loadingMessage = document.getElementById('loading-message');
                if (loadingOverlay && loadingMessage) {
                    loadingMessage.textContent = message || 'Processing font file...';
                    loadingOverlay.style.display = 'flex';
                }
            }
            
            function hideLoading() {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function showErrorModal(message) {
                const errorModal = document.getElementById('error-modal');
                const errorMessage = document.getElementById('error-message');
                if (errorModal && errorMessage) {
                    errorMessage.textContent = message || 'An error occurred.';
                    errorModal.classList.add('is-active');
                }
            }
            
            function closeErrorModal() {
                const errorModal = document.getElementById('error-modal');
                if (errorModal) {
                    errorModal.classList.remove('is-active');
                }
            }
            """)
        
        # Inline script for file selection feedback
        t.script("""
        function fileSelected(event) {
            const fileName = event.target.files.length > 0 ? event.target.files[0].name : 'No file chosen';
            document.getElementById('file-name-display').textContent = fileName;
            
            // Signal Python to process
            const fileSelectedEvent = new CustomEvent('fileSelected');
            document.dispatchEvent(fileSelectedEvent);
        }
        """)
        
        # Error message
        if self.state["error"]:
            with t.div(class_="notification is-danger mt-4"):
                t.p(self.state["error"])
        
        # Font preview section (only shown when font is loaded)
        if self.state["font_loaded"]:
            with t.div(class_="box mt-4"):
                t.h4(f"Font Preview: {self.state['font_name']}", class_="title is-5 mb-3")
                
                # Preview controls
                with t.div(class_="field"):
                    t.label("Preview Text", class_="label")
                    with t.div(class_="control"):
                        t.input(
                            type="text",
                            class_="input",
                            value=self.state["preview_text"],
                            on_input=self.on_preview_text_change,
                            placeholder="Enter text to preview"
                        )
                
                # Size slider
                with t.div(class_="field mt-3"):
                    t.label(f"Size: {self.state['preview_size']}px", class_="label")
                    with t.div(class_="control"):
                        t.input(
                            type="range",
                            min="8",
                            max="72",
                            value=str(self.state["preview_size"]),
                            class_="slider is-fullwidth",
                            on_input=self.on_size_change
                        )
                
                # Preview area
                with t.div(class_="font-preview", id="preview-area"):
                    t.div(
                        self.state["preview_text"],
                        id="preview-text",
                        class_="preview-text",
                        style=f"font-size: {self.state['preview_size']}px;"
                    )
            
            # Font information tabs
            with t.div(class_="box mt-4"):
                t.h4("Font Information", class_="title is-5 mb-3")
                
                # Basic info
                with t.div(class_="notification is-light"):
                    t.pre(self.state["info"])
                
                # Reset button
                with t.div(class_="field mt-3"):
                    t.button("Reset", class_="button is-light", on_click=self.on_reset_click)
        
        # Error message
        if self.state["error"]:
            with t.div(class_="notification is-danger mt-4"):
                t.p(self.state["error"])

    def attached(self):
        debug_log("Setting up file change handler")
        
        # File change handler
        async def on_file_change(event):
            debug_log("File input changed")
            try:
                file = event.target.files.item(0)
                if not file:
                    debug_log("No file selected")
                    return
                    
                debug_log(f"File selected: {file.name}")
                
                # Read file data
                array_buffer = await file.arrayBuffer()
                data = array_buffer.to_bytes()
                debug_log(f"Read {len(data)} bytes")
                
                # Store data for processing
                self.state["file_data"] = data
                debug_log("File data stored in state")
                
                # Process immediately
                self.process_font()
                
            except Exception as e:
                debug_log(f"Error reading file: {str(e)}")
                debug_log(traceback.format_exc())
                self.state["error"] = f"Error reading file: {str(e)}"
                
        # Set up event listener with proper cleanup
        callback = create_proxy(on_file_change)
        
        # Listen for the custom file selected event
        def on_file_selected(event):
            debug_log("Custom file selected event received")
            self.on_process_click(None)
            
        file_selected_callback = create_proxy(on_file_selected)
        document.addEventListener("fileSelected", file_selected_callback)
        debug_log("Added custom fileSelected event listener")
        
        # Ensure handler is attached after DOM is fully ready
        def attach_handler():
            # Get the file input element
            upload = document.getElementById("font-upload")
            if upload:
                # Try to remove any existing listeners first
                try:
                    upload.removeEventListener("change", callback)
                except:
                    pass
                
                # Add the event listener
                upload.addEventListener("change", callback)
                debug_log("Change event listener attached")
                
                # Also add input event listener as fallback
                try:
                    upload.addEventListener("input", callback)
                    debug_log("Input event listener attached as fallback")
                except:
                    pass
            else:
                debug_log("ERROR: Could not find upload element")
        
        # Run the attach handler
        attach_handler()
        
        # Check for font URL parameter in the URL (for shared fonts)
        try:
            url_params = window.location.search
            debug_log(f"URL parameters: {url_params}")
            
            if url_params:
                # Simple parsing for the 'font' parameter
                import urllib.parse
                params = urllib.parse.parse_qs(url_params.lstrip('?'))
                debug_log(f"Parsed parameters: {params}")
                
                if 'font' in params and params['font']:
                    shared_font_url = params['font'][0]
                    debug_log(f"Found shared font URL: {shared_font_url}")
                    
                    # Update the URL input field
                    url_input = document.getElementById("font-url")
                    if url_input:
                        url_input.value = shared_font_url
                        self.state["font_url"] = shared_font_url
                        
                        # Process the shared font automatically
                        debug_log("Processing shared font automatically")
                        self.on_process_click(None)
        except Exception as e:
            debug_log(f"Error processing URL parameters: {str(e)}")
            debug_log(traceback.format_exc())

    def on_preview_text_change(self, event):
        self.state["preview_text"] = event.target.value
        # Update the preview text
        preview_text_element = document.getElementById("preview-text")
        if preview_text_element:
            preview_text_element.textContent = self.state["preview_text"]

    def on_size_change(self, event):
        size = int(event.target.value)
        self.state["preview_size"] = size
        # Update the preview size
        preview_text_element = document.getElementById("preview-text")
        if preview_text_element:
            preview_text_element.style.fontSize = f"{size}px"

    async def fetch_font_from_url_wrapper(self, url):
        debug_log(f"Fetching font from URL wrapper: {url}")
        self.state["error"] = "" # Clear previous errors
        try:
            font_bytes = await fetch_font_bytes_from_url(url)
            if font_bytes:
                debug_log(f"Successfully fetched {len(font_bytes)} bytes from URL.")
                return font_bytes
            else:
                # fetch_font_bytes_from_url should have logged the specific error
                error_msg = "Failed to fetch font from URL. CORS or network issue likely."
                debug_log(error_msg)
                self.state["error"] = error_msg
                try: window.showErrorModal(error_msg)
                except: pass
                return None
        except Exception as e:
            error_msg = f"Error in fetch_font_from_url_wrapper: {str(e)}"
            debug_log(error_msg)
            debug_log(traceback.format_exc())
            self.state["error"] = error_msg
            try: window.showErrorModal(error_msg)
            except: pass
            return None

    def on_process_click(self, event):
        debug_log("Process button clicked")
        self.state["is_processing"] = True
        self.state["error"] = ""
        self.state["info"] = ""
        self.state["font_loaded"] = False
        
        try:
            window.showLoading("Preparing to process font...")
        except Exception as loading_error:
            debug_log(f"Error showing loading animation: {str(loading_error)}")

        upload_element = document.getElementById("font-upload")
        # Check if a file is selected in the upload element
        # self.state["file_data"] should be set by on_file_change if a file was selected
        
        if self.state.get("file_data") and upload_element and upload_element.files and upload_element.files.length > 0:
            debug_log("Using uploaded file data.")
            file_name = upload_element.files.item(0).name if hasattr(upload_element.files.item(0), 'name') else "uploaded_file"
            
            async def process_uploaded_file_data():
                try:
                    window.showLoading(f"Analyzing font: {file_name}...")
                    # self.state["file_data"] should already be Python bytes
                    self.process_font_data(self.state["file_data"], file_name)
                except Exception as e:
                    error_msg = f"Error processing uploaded file data: {str(e)}"
                    debug_log(error_msg)
                    debug_log(traceback.format_exc())
                    self.state["error"] = error_msg
                    try:
                        window.hideLoading()
                        window.showErrorModal(error_msg)
                    except: pass
                finally:
                    self.state["is_processing"] = False
                    if not self.state["font_loaded"]: # Ensure loading is hidden if processing fails
                        try: window.hideLoading()
                        except: pass
            
            import asyncio
            asyncio.ensure_future(process_uploaded_file_data())
            return

        url_input_element = document.getElementById("font-url")
        if url_input_element and url_input_element.value:
            font_url = url_input_element.value.strip()
            if font_url:
                debug_log(f"Using font URL: {font_url}")

                async def process_url_async():
                    try:
                        window.showLoading(f"Fetching font from URL: {font_url}...")
                        font_bytes = await self.fetch_font_from_url_wrapper(font_url)
                        if font_bytes:
                            self.state["file_data"] = font_bytes # Store for potential reprocessing or preview
                            window.showLoading(f"Analyzing font from URL...")
                            self.process_font_data(font_bytes, font_url.split('/')[-1])
                        else:
                            # Error already handled by fetch_font_from_url_wrapper
                            self.state["is_processing"] = False
                            try: window.hideLoading()
                            except: pass

                    except Exception as e:
                        error_msg = f"Error processing URL: {str(e)}"
                        debug_log(error_msg)
                        debug_log(traceback.format_exc())
                        self.state["error"] = error_msg
                        try:
                            window.hideLoading()
                            window.showErrorModal(error_msg)
                        except: pass
                    finally:
                        if not self.state["font_loaded"]: # Ensure loading is hidden if processing fails early
                           self.state["is_processing"] = False
                           try: window.hideLoading()
                           except: pass
                
                import asyncio
                asyncio.ensure_future(process_url_async())
                return

        debug_log("No file selected or URL provided.")
        self.state["error"] = "Please select a font file or provide a valid URL."
        self.state["is_processing"] = False
        try:
            window.hideLoading()
            window.showErrorModal(self.state["error"])
        except: pass
        
    def on_url_change(self, event):
        debug_log(f"URL changed: {event.target.value}")
        self.state["font_url"] = event.target.value
        self.state["file_data"] = None # Clear file data if URL is changed
        upload_element = document.getElementById("font-upload")
        if upload_element:
            upload_element.value = "" # Clear file input visually
        file_name_display = document.getElementById("file-name-display")
        if file_name_display:
            file_name_display.textContent = "No file chosen"


    def on_reset_click(self, event):
        debug_log("Reset clicked")
        self.state["info"] = ""
        self.state["error"] = ""
        self.state["file_data"] = None
        self.state["is_processing"] = False
        self.state["font_loaded"] = False
        self.state["font_name"] = ""
        self.state["detailed_info"] = {}
        self.state["preview_text"] = "The quick brown fox jumps over the lazy dog"
        self.state["preview_size"] = 36
        
        upload_element = document.getElementById("font-upload")
        if upload_element:
            upload_element.value = ""
        file_name_display = document.getElementById("file-name-display")
        if file_name_display:
            file_name_display.textContent = "No file chosen"
            
        url_input_element = document.getElementById("font-url")
        default_url = "https://github.com/google/fonts/raw/refs/heads/main/ofl/abrilfatface/AbrilFatface-Regular.ttf"
        if url_input_element:
            url_input_element.value = default_url
        self.state["font_url"] = default_url
            
        self.remove_font_face()
        try: window.hideLoading() # Ensure loading is hidden on reset
        except: pass


    def remove_font_face(self):
        style_element = document.getElementById("font-face-style")
        if style_element:
            style_element.remove()
            debug_log("Removed font-face style")

    def add_font_face(self, font_data_bytes, font_name_for_debug):
        self.remove_font_face()
        try:
            # Convert Python bytes to Uint8Array for Blob constructor
            uint8_array = to_js(font_data_bytes, typ="Uint8Array")

            # Create a Blob from the Uint8Array
            # Use Object.new to call the Blob constructor with an array of parts and options object
            blob_parts = to_js([uint8_array])
            blob_options = Object()
            blob_options.type = "font/ttf" # Assuming ttf, adjust if type is known otherwise

            font_blob = Blob.new(blob_parts, blob_options)
            font_url_obj = window.URL.createObjectURL(font_blob)

            style_element = document.createElement("style")
            style_element.id = "font-face-style"
            style_element.textContent = f"""
            @font-face {{
                font-family: 'PreviewFont';
                src: url('{font_url_obj}');
                font-weight: normal;
                font-style: normal;
            }}
            #preview-text {{
                font-family: 'PreviewFont', sans-serif;
            }}
            """
            document.head.appendChild(style_element)
            debug_log(f"Added font-face for {font_name_for_debug} using Object URL: {font_url_obj}")
        except Exception as e:
            debug_log(f"Error in add_font_face: {str(e)}")
            debug_log(traceback.format_exc())
            self.state["error"] = "Could not create font preview."


    def process_font_data(self, font_bytes, filename="font_file"):
        debug_log(f"Processing font data for: {filename}")
        self.state["error"] = ""
        try:
            if not font_bytes:
                self.state["error"] = "No font data to process."
                debug_log(self.state["error"])
                self.state["is_processing"] = False
                try: window.hideLoading()
                except: pass
                return

            analysis_result = analyze_font_data(font_bytes, filename)
            
            # Format basic info for display
            basic_info_display = []
            if "name" in analysis_result:
                basic_info_display.append(f"Family Name: {analysis_result['name'].get('font_family', 'N/A')}")
                basic_info_display.append(f"Subfamily: {analysis_result['name'].get('font_subfamily', 'N/A')}")
                basic_info_display.append(f"Full Name: {analysis_result['name'].get('full_name', 'N/A')}")
                basic_info_display.append(f"Version: {analysis_result['name'].get('version', 'N/A')}")
                basic_info_display.append(f"PostScript Name: {analysis_result['name'].get('postscript_name', 'N/A')}")
            
            if "head" in analysis_result:
                basic_info_display.append(f"Units Per Em: {analysis_result['head'].get('unitsPerEm', 'N/A')}")
            
            if "glyf" in analysis_result: # Using 'glyf' presence as an indicator of glyph count source
                 basic_info_display.append(f"Number of Glyphs: {analysis_result['glyf'].get('num_glyphs', 'N/A')}")
            elif "CFF " in analysis_result and "top_dict_data" in analysis_result["CFF "]: # For CFF fonts
                 basic_info_display.append(f"Number of Glyphs: {analysis_result['CFF ']['top_dict_data'].get('num_glyphs', 'N/A')}")


            if "tables" in analysis_result:
                basic_info_display.append(f"Tables: {', '.join(sorted(analysis_result['tables']))}")

            self.state["info"] = "\n".join(basic_info_display)
            
            font_family_name = analysis_result.get("name", {}).get("font_family", "Unknown Font")
            font_subfamily_name = analysis_result.get("name", {}).get("font_subfamily", "")
            self.state["font_name"] = f"{font_family_name} {font_subfamily_name}".strip()
            
            self.state["detailed_info"] = analysis_result # Store the full analysis
            self.state["font_loaded"] = True
            debug_log(f"Font info extracted for {self.state['font_name']}")
            
            # Add font-face for preview using the original font_bytes
            self.add_font_face(font_bytes, self.state["font_name"])
            
        except Exception as e:
            error_msg = f"Error processing font data in process_font_data: {str(e)}"
            debug_log(error_msg)
            debug_log(traceback.format_exc())
            self.state["error"] = error_msg
            self.state["font_loaded"] = False
            try: window.showErrorModal(error_msg) # Show error in modal
            except: pass
        finally:
            self.state["is_processing"] = False
            try: window.hideLoading() # Ensure loading is hidden
            except: pass

app.mount("#app")
debug_log("App mounted")
</script>

<!-- JavaScript for UI interactions -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Navbar burger menu
  const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(el => {
      el.addEventListener('click', () => {
        const target = el.dataset.target;
        const $target = document.getElementById(target);
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }

  // Functions to open and close a modal
  function openModal($el) {
    $el.classList.add('is-active');
  }

  function closeModal($el) {
    $el.classList.remove('is-active');
  }

  function closeAllModals() {
    (document.querySelectorAll('.modal') || []).forEach(($modal) => {
      closeModal($modal);
    });
  }

  // Add a click event on buttons to open a specific modal
  (document.querySelectorAll('.js-modal-trigger') || []).forEach(($trigger) => {
    const modal = $trigger.dataset.target;
    const $target = document.getElementById(modal);

    $trigger.addEventListener('click', () => {
      openModal($target);
    });
  });

  // Add a click event on various child elements to close the parent modal
  (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
    const $target = $close.closest('.modal');

    $close.addEventListener('click', () => {
      closeModal($target);
    });
  });

  // Add a keyboard event to close all modals
  document.addEventListener('keydown', (event) => {
    const e = event || window.event;

    if (e.keyCode === 27) { // Escape key
      closeAllModals();
    }
  });
});
</script>
</body>
</html> 